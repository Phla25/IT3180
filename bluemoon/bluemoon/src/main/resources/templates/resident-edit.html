<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chỉnh Sửa Cư Dân - BlueMoon Portal</title>

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-building"></i>
                <span>BlueMoon Portal</span>
            </div>
            <div class="user-profile">
                <div class="avatar"><i class="fas fa-user-circle"></i></div>
                <div class="user-info">
                    <span class="user-name" th:text="${user?.hoVaTen} ?: 'Tên Người Dùng'">Tên Người Dùng</span>
                    <span class="user-role" th:text="${user?.vaiTro?.dbValue} ?: 'Vai Trò'">Vai Trò</span>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <a th:href="@{/admin/dashboard}" class="nav-item">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </a>
            <a th:href="@{/admin/resident-list}" class="nav-item active">
                <i class="fas fa-users"></i>
                <span>Quản Lý Cư Dân</span>
            </a>
            <a href="apartments.html" class="nav-item">
                <i class="fas fa-home"></i>
                <span>Quản Lý Căn Hộ</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-users-cog"></i>
                <span>Quản Lý Hộ Gia Đình</span>
            </a>
            <a href="assets.html" class="nav-item">
                <i class="fas fa-building"></i>
                <span>Quản Lý Tài Sản</span>
            </a>
            <a href="fees.html" class="nav-item">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>Quản Lý Khoản Phí</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-concierge-bell"></i>
                <span>Quản Lý Dịch Vụ</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Xử Lý Sự Cố</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-bell"></i>
                <span>Gửi Thông Báo</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-chart-bar"></i>
                <span>Báo Cáo Thống Kê</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="#" class="nav-item">
                <i class="fas fa-cog"></i>
                <span>Cài Đặt</span>
            </a>
        </div>
    </aside>
    <header class="header">
        <div class="header-left">
            <button class="menu-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <h1>Chỉnh Sửa Cư Dân</h1>
        </div>

        <div class="header-right">
            <div class="notification-icon">
                <i class="fas fa-bell"></i>
                <span class="badge">3</span>
            </div>

            <div class="user-menu">
                <div class="user-info">
                    <span class="user-name" th:text="${user?.hoVaTen} ?: 'N/A'">Nguyễn Văn Thanh</span>
                    <span class="user-role" th:text="${user?.vaiTro?.dbValue} ?: 'N/A'">BAN_QUAN_TRI</span>
                </div>
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="dropdown-menu">
                    <a href="profile.html">
                        <i class="fas fa-user"></i> Thông Tin Cá Nhân
                    </a>
                    <a href="#">
                        <i class="fas fa-cog"></i> Cài Đặt
                    </a>
                    <hr>
                    <button type="button" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Đăng Xuất
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div style="margin-bottom: 20px;">
            <a th:href="@{/admin/resident-list}" style="color: var(--gray); text-decoration: none;">
                <i class="fas fa-arrow-left"></i> Quay lại danh sách
            </a>
        </div>
        
        <div th:if="${successMessage}" class="alert alert-success" role="alert">
            <span th:text="${successMessage}">Cập nhật thành công.</span>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
            <span th:text="${errorMessage}">Lỗi khi cập nhật.</span>
        </div>

        <div class="content-card" style="max-width: 1000px;">
            <div class="content-card-header">
                <div>
                    <h2 class="content-card-title" th:text="|Chỉnh Sửa Thông Tin Cư Dân: ${resident.hoVaTen} (${resident.cccd})|">Chỉnh Sửa Thông Tin Cư Dân</h2>
                    <p style="color: var(--gray); font-size: 14px; margin-top: 4px;">
                        Cập nhật thông tin chi tiết của cư dân
                    </p>
                </div>
            </div>

            <form id="residentForm" th:object="${resident}" th:action="@{/admin/resident-edit}" method="post">
                
                <input type="hidden" th:field="*{cccd}" id="hiddenCccd">
                

                <div style="margin-bottom: 32px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--dark);">
                        <i class="fas fa-user-circle"></i> Thông Tin Tài Khoản
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">CCCD</label>
                            <input type="text" class="form-control" th:value="*{cccd}" disabled
                                style="background: var(--gray-lighter); cursor: not-allowed;">
                            <small style="color: var(--gray); font-size: 12px;">CCCD không thể chỉnh sửa</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Mật khẩu mới</label>
                            <input type="password" class="form-control" name="matKhauMoi"
                                placeholder="Để trống nếu không muốn đổi mật khẩu" minlength="6">
                            <small style="color: var(--gray); font-size: 12px;">Chỉ nhập nếu muốn thay đổi mật khẩu</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Vai trò <span style="color: var(--danger-color);">*</span></label>
                            <select class="form-control" th:field="*{vaiTro}" required>
                                <option th:each="role : ${roles}" 
                                        th:value="${role}" 
                                        th:text="${role.dbValue}">Ban Quản Trị</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Là cư dân</label>
                            <select class="form-control" th:field="*{laCuDan}">
                                <option th:value="true" th:text="'Có'">Có</option>
                                <option th:value="false" th:text="'Không'">Không</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 32px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--dark);">
                        <i class="fas fa-id-card"></i> Thông Tin Cá Nhân
                    </h3>

                    <div class="form-group">
                        <label class="form-label">Họ và tên <span style="color: var(--danger-color);">*</span></label>
                        <input type="text" class="form-control" th:field="*{hoVaTen}"
                            placeholder="Nhập họ và tên đầy đủ" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ngày sinh <span
                                        style="color: var(--danger-color);">*</span></label>
                            <input type="date" class="form-control" th:field="*{ngaySinh}" max="2010-12-31"
                                required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Giới tính <span
                                        style="color: var(--danger-color);">*</span></label>
                            <select class="form-control" th:field="*{gioiTinh}" required>
                                <option th:each="gender : ${genders}" 
                                        th:value="${gender}" 
                                        th:text="${gender.dbValue}">Nam</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Quê quán</label>
                        <textarea class="form-control" th:field="*{queQuan}" rows="2"
                            placeholder="Nhập địa chỉ quê quán đầy đủ"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Nghề nghiệp</label>
                        <input type="text" class="form-control" th:field="*{ngheNghiep}" 
                            placeholder="Nhập nghề nghiệp">
                    </div>
                </div>

                <div style="margin-bottom: 32px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--dark);">
                        <i class="fas fa-phone"></i> Thông Tin Liên Hệ
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email <span style="color: var(--danger-color);">*</span></label>
                            <input type="email" class="form-control" th:field="*{email}"
                                placeholder="example@gmail.com" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Số điện thoại <span
                                        style="color: var(--danger-color);">*</span></label>
                            <input type="tel" class="form-control" th:field="*{soDienThoai}" id="soDienThoai"
                                placeholder="0912345678" pattern="[0-9]{10,11}" required>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 32px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--dark);">
                        <i class="fas fa-toggle-on"></i> Trạng Thái
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Trạng thái tài khoản</label>
                            <select class="form-control" th:field="*{trangThaiTaiKhoan}">
                                <option th:each="status : ${accountStatuses}" 
                                        th:value="${status}" 
                                        th:text="${status.dbValue}">Hoạt động</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Trạng thái dân cư</label>
                            <select class="form-control" th:field="*{trangThaiDanCu}">
                                <option value="">-- Không áp dụng --</option>
                                <option th:each="rStatus : ${residentStatuses}" 
                                        th:value="${rStatus}" 
                                        th:text="${rStatus.dbValue}">Thường trú</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 32px; padding: 16px; background: var(--gray-lighter); border-radius: 8px;">
                    <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--gray);">
                        <i class="fas fa-info-circle"></i> Thông Tin Hệ Thống
                    </h3>
                    <div class="form-row">
                        <div style="font-size: 13px; color: var(--gray); margin-right: 24px;">
                            <strong>Ngày tạo:</strong>
                            <span th:text="*{ngayTao != null ? #temporals.format(ngayTao, 'dd/MM/yyyy HH:mm') : 'N/A'}">14/10/2024 10:30</span>
                        </div>
                        <div style="font-size: 13px; color: var(--gray); margin-right: 24px;">
                            <strong>Lần đăng nhập cuối:</strong>
                            <span th:text="*{lanDangNhapCuoi != null ? #temporals.format(lanDangNhapCuoi, 'dd/MM/yyyy HH:mm') : 'Chưa từng'}">14/10/2024 15:20</span>
                        </div>
                        <div style="font-size: 13px; color: var(--gray);">
                            <strong>Cập nhật lần cuối:</strong>
                            <span th:text="*{ngayCapNhat != null ? #temporals.format(ngayCapNhat, 'dd/MM/yyyy HH:mm') : 'N/A'}">14/10/2024 16:00</span>
                        </div>
                    </div>
                </div>

                <div class="flex-between" style="padding-top: 24px; border-top: 1px solid var(--gray-light);">
                    <a th:href="@{/admin/resident-list}" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Hủy bỏ
                    </a>

                    <div class="flex gap-2">
                        <button type="button" class="btn btn-danger" onclick="confirmDeleteCurrent()">
                            <i class="fas fa-trash"></i>
                            Xóa cư dân
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Cập nhật thông tin
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 BlueMoon Apartment Management System. All rights reserved.</p>
            <div class="footer-links">
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
                <a href="#">Contact Support</a>
            </div>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/js/main.js"></script>

    <script th:inline="javascript">
        // Lấy CCCD và Tên hiện tại từ đối tượng resident đã được truyền từ Controller (An toàn)
        const currentCccd = /*[[${resident.cccd}]]*/ '000000000000';
        const currentName = /*[[${resident.hoVaTen}]]*/ 'Cư Dân';
        const deleteBaseUrl = /*[[@{/admin/resident-delete}]]*/ '/admin/resident-delete';

        // Khởi tạo Alert utility (Giả định nằm trong main.js, nếu không, cần định nghĩa)
        const Alert = {
            error: (title, text) => Swal.fire({ icon: 'error', title, text, confirmButtonColor: '#DC3545' }),
            loading: (title) => Swal.fire({ title, allowOutsideClick: false, showConfirmButton: false, didOpen: () => { Swal.showLoading() } }),
            success: (title, text) => Swal.fire({ icon: 'success', title, text, confirmButtonColor: '#4F46E5' })
        };
        
        // Hàm validation cơ bản
        function validateForm(formId) {
            const form = document.getElementById(formId);
            return form && form.checkValidity();
        }

        // Xử lý nút xóa cư dân hiện tại
        function confirmDeleteCurrent() {
             Swal.fire({
                title: 'Xác nhận xóa cư dân',
                html: `Bạn đang chuyển trạng thái cư dân <strong>${currentName}</strong> (CCCD: ${currentCccd}). <br> Vui lòng chọn lý do:`,
                icon: 'warning',
                input: 'radio',
                inputOptions: {
                    'roi_di': 'Đã chuyển đi (Rời chung cư)', 
                    'da_chet': 'Đã mất'
                },
                inputValidator: (value) => {
                    if (!value) {
                        return 'Bạn cần chọn một lý do!'
                    }
                },
                showCancelButton: true,
                confirmButtonColor: '#DC3545',
                cancelButtonColor: '#6C757D',
                confirmButtonText: 'Xác nhận Xóa',
                cancelButtonText: 'Hủy bỏ'
            }).then((result) => {
                if (result.isConfirmed) {
                    const lyDo = result.value;
                    // Chuyển hướng đến Controller với CCCD và Lý do
                    window.location.href = `${deleteBaseUrl}?cccd=${currentCccd}&lyDo=${lyDo}`;
                }
            });
        }
        
        // Ràng buộc submit form (Hiện tại chỉ là JS, cần chuyển logic sang Spring)
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('residentForm');
            if (form) {
                form.addEventListener('submit', function (e) {
                    if (!validateForm('residentForm')) {
                         e.preventDefault();
                         Alert.error('Lỗi', 'Vui lòng điền đầy đủ thông tin bắt buộc');
                    } 
                    // Nếu form hợp lệ, Spring MVC sẽ gửi POST request đến /admin/resident-edit
                });
            }

            const phoneInput = document.getElementById('soDienThoai');
            if (phoneInput) {
                phoneInput.addEventListener('input', function () {
                     this.value = this.value.replace(/[^0-9]/g, '');
                });
            }
        });
        
        // Hàm toggleSidebar (Đảm bảo hoạt động)
        if (typeof window.toggleSidebar === 'undefined') {
             window.toggleSidebar = function() {
                $('aside.sidebar').toggleClass('active');
                $('main.main-content').toggleClass('sidebar-open');
                $('header.header').toggleClass('sidebar-open');
            };
        }
    </script>
</body>

</html>
